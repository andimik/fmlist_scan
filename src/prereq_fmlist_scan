
BASE=$(pwd)
if [ -z "${FMLIST_SCAN_USER}" ]; then
  export FMLIST_SCAN_USER="pi"
fi
if [ -z "${FMLIST_SCAN_MOUNT}" ]; then
  export FMLIST_SCAN_MOUNT="1"
fi

apt-get -y install htop powertop at lsof mc nano vim zip alpine dpkg
apt-get -y install ncdu screen parallel sshfs wget curl iftop util-linux
apt-get -y install dos2unix exfat-utils dosfstools
apt-get -y install sox lame espeak-ng alsa-utils
apt-get -y install netcat-openbsd netcat-traditional socat

if [ ${FMLIST_SCAN_SETUP_GPS} = "1" ]; then
  apt-get -y install gpsd gpsd-clients
fi
if [ ${FMLIST_SCAN_RASPI} -ne 0 ]; then
  apt-get -y install libraspberrypi-bin
fi

apt-get -y install build-essential git git-gui gitk cmake libtool autotools-dev automake colordiff jq
apt-get -y install usbutils libusb-1.0-0-dev libsndfile1-dev

if [ "${FMLIST_SCAN_MOUNT}" = "1" ]; then
  #sed -i '/\/mnt\/sda1/d' /etc/fstab
  # deletion with sed requires the '/' for the regexp. thus '/' requires to be escaped
  DELEXPR=$( echo -n "${FMLIST_SCAN_RESULT_DIR}" | sed 's#/#\\/#g' )
  sed -i "/${DELEXPR}/d" /etc/fstab
  echo "${FMLIST_SCAN_RESULT_DEV}  ${FMLIST_SCAN_RESULT_DIR}  vfat    defaults,noatime,user,noauto  0  0" >>/etc/fstab
  mkdir -p ${FMLIST_SCAN_RESULT_DIR}
  chown ${FMLIST_SCAN_USER}:${FMLIST_SCAN_USER} ${FMLIST_SCAN_RESULT_DIR}
fi

if [ ! -f /home/${FMLIST_SCAN_USER}/.bash_aliases ]; then
  sudo -u ${FMLIST_SCAN_USER} bash -c "touch /home/${FMLIST_SCAN_USER}/.bash_aliases"
fi
sudo -u ${FMLIST_SCAN_USER} bash -c "sed -i '#$(pwd)/.bash_aliases#d' /home/${FMLIST_SCAN_USER}/.bash_aliases"
sudo -u ${FMLIST_SCAN_USER} bash -c "echo \". $(pwd)/.bash_aliases\" >>/home/${FMLIST_SCAN_USER}/.bash_aliases"


if [ ! -d /home/${FMLIST_SCAN_USER}/.ssh ]; then
  echo "installing ssh authorized_keys"
  sudo -u ${FMLIST_SCAN_USER} bash -c "mkdir -p /home/${FMLIST_SCAN_USER}/.ssh"
  sudo -u ${FMLIST_SCAN_USER} bash -c "cp authorized_keys /home/${FMLIST_SCAN_USER}/.ssh/"
  sudo -u ${FMLIST_SCAN_USER} bash -c "chmod 0600 /home/${FMLIST_SCAN_USER}/.ssh/authorized_keys"
fi

sudo -u ${FMLIST_SCAN_USER} bash -c "mkdir -p /home/${FMLIST_SCAN_USER}/bin"

cp gpstime.sh /home/${FMLIST_SCAN_USER}/bin/
cp get_gpstime.sh /home/${FMLIST_SCAN_USER}/bin/
chown ${FMLIST_SCAN_USER}:${FMLIST_SCAN_USER} /home/${FMLIST_SCAN_USER}/bin/gpstime.sh
chown ${FMLIST_SCAN_USER}:${FMLIST_SCAN_USER} /home/${FMLIST_SCAN_USER}/bin/get_gpstime.sh

if [ ${FMLIST_SCAN_SETUP_GPS} ="1" ]; then
  systemctl stop gpsd.socket
  systemctl disable gpsd.socket
  cp gpsd.conf /etc/default/gpsd
  systemctl enable gpsd.socket
  systemctl start gpsd.socket
fi

source setup_config

source setup_leds

source setup_scanner

# add crontab entry: execute scanner @restart
source setup_crontab

cd ${BASE}

